# HyE - YouTube Recommendations

This [las2peer](https://github.com/rwth-acis/las2peer) service is used to obtain user data from YouTube via the YouTube Data API to generate custom video recommendations.
To this end, it stores las2peer identities and associates them with YouTube IDs which are used to obtain YouTube watch data.
The service extends the functionality of the [HyE - YouTube Proxy service](https://github.com/rwth-acis/hye-youtube-proxy) by retrieving users' YouTube rating data from the YouTube Data API and evaluating their similarity based on machine learning models.
To this end, it implements the [findMatch function](https://github.com/rwth-acis/hye-youtube-recommendations/blob/master/youtube_recommendations/src/main/java/i5/las2peer/services/hyeYouTubeRecommendations/YouTubeRecommendations.java#L562) which matches a given user to another user from a given list.
Additionally, users can set the desired similarity of the matched user themselves.

## Paths

The HyE Recommendations service's main service class is called YouTubeRecommendations and runs under the service path `/hye-recommendations`.

### Main path
The main path (`/`) is used to manage users' YouTube data.
As such, sending a GET retrieves all rating data stored for the requesting user from the connected database, sending a POST initiates a synchronization with the database and YouTube Data API, and a DELETE causes this user's data to be deleted from the database.
The YouTube rating data includes all videos the requesting user liked, disliked, put into playlists, or that were uploaded to channels this user is subscribed to.

### Google OAuth login
In order to fetch personal data from the YouTube Data API, authorization tokens are needed which are issued by Google's OAuth servers.
The login is implemented by the [Google OAuth library](https://developers.google.com/api-client-library/java/google-oauth-java-client/) and available under the `/login` path.
From their users are automatically redirected to a Google login screen which on a successful login redirects them to `/auth` with the token in the URL, so that it can be read and stored by the service.

### Alpha
The `/alpha` path is used to access the *alpha* value stored for the requesting user in the las2peer storage.
This *alpha* value is used to set the desired similarity of the recommendations obtained through this service.

The current *alpha* value can be retrieved with a GET and changed with a DELETE.

### Models
The machine learning models are given as the result of *matrix factorization* and *word2vec word embeddings*, served under `/matrix-factorization` and `/word2vec` respectively.
The models are generated by sending a POST to the respective path, and can be retrieved with a GET.

### Synch
Since the YouTube synchronization only retrieves partial data on the videos rated by users, the missing video data should be fetched before training the models.
This is done by sending a GET to the `/synch` path.

### Video
Additionally, video data for any given YouTube video can be retrieved by sending a GET to `/video?id=VIDEO_ID` with the respective YouTube video ID as a query parameter.
This returns the following information:

* YouTube video ID
* Upload channel ID
* Video title
* Channel title
* Video description
* Thumbnail URL
* Video Tags
* Category ID
* Video upload date
* Video view count

### Observation (only for user study)
And lastly, in order to compute the precision of the generated recommendations, users are encouraged to every now and then send the number of interesting videos displayed on a given page.
Since these are stored in the database, this function is also implemented by this service.
This function is served under the `/observation` path and implemented as a POST expecting the following object in the body.

* **id**        -> string (max length 20 characters)
* **alpha**     -> double
* **cf**        -> double
* **w2v**       -> double
* **noVideos**  -> integer
* **noHelpful** -> integer

## Deployment
This service requires Gradle 7.2 and Java 17.
In order to build a JAR, which can then be started on a las2peer node, clone this repository and run `gradle build jar`.
Before starting the service, a dedicated service agent should be created, which is then used by the service to store and manage data.
In addition, the following processes and resources are required.

### MySQL Database
Since the Recommendations service needs to persist data, it tries to connect to a MySQL database running on the standard port `3306` (host, DB name, and user credentials are set in properties file).
On service startup, it tries to create the required tables.
However, on failure it is assumed that the tables already exist.
The service relies on the [Java SQL library](https://docs.oracle.com/javase/8/docs/api/java/sql/package-summary.html) for this connection and expects the database to use the JDBC driver.
The service can theoretically also be started without a database connection, however it is unable to provide virtually any functionality in this case.

### YouTube API
The service is also reliant on a Google API key and OAuth client.
These API credentials can be generated on the [Google Cloud Platform](https://console.cloud.google.com).
For more details please refer to the [official documentation](https://developers.google.com/api-client-library/java/google-oauth-java-client/setup).

### Python MlLib
Lastly, to compute the machine learning models, the Recommendations service relies on the [Python MlLib server](https://github.com/rwth-acis/hye-python-mllib).
Thus, if this service is not available, a large part of the service functionality cannot be used.

### Configuration
The database credentials, API keys, and service locations, as well as additional configuration parameters, are passed via the `./etc/i5.las2peer.services.hyeYouTubeRecommendations.YouTubeRecommendations.properties` file.
Below, a table with the configuration options and their purpose is provided.

| Name | Value | Optional | Description |
| ---- | ----- | -------- | ----------- |
| `rootUri` | Web URI | No | The root address under which the service is deployed |
| `serviceAgentName` | String | No | Name of an existing las2peer agent used by the service to store data |
| `serviceAgentPw` | String | No | Password of las2peer service agent |
| `clientId` | String | No | The ID of the Google OAuth client used by the service |
| `clientSecret` | String | No | The Secret belonging to that ID |
| `apiKey` | String | No | A valid API key for the Google Data API |
| `mysqlHost` | Web URI | No | The address of the MySQL database used by this service |
| `mysqlDatabase` | String | No | Name of the MySQL database used by this service |
| `mysqlUser` | String | No | Name of the MySQL user used by this service |
| `mysqlPassword` | String | No | Password of the MySQL user used by this service |
| `mlLibUrl` | Web URI | No | The address of the Python MlLib instance used by this service |
| `modelName` | String | Yes | Name of the machine learning model created and stored by the remote Python MlLib service |
